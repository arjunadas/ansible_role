- hosts: all
  tasks:
    - name: Main block
      block:
        - name: Git clone   # clone code
          ansible.builtin.git:
            repo: 'https://github.com/arjunadas/ansible_target.git'
            dest: /tmp/django
            clone: yes
            update: yes
            force: yes
          tags:
            - git_clone
            
        - name: Add an Apt signing key, uses whichever key is at the URL
          apt_key:
            url: https://download.docker.com/linux/ubuntu/gpg
            state: present
          tags:
            - apt_key

        - name: Add Repo
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release | lower}} stable"
            state: present
            update_cache: yes
          tags:
            - add_repo

        - name: Install soft #install soft
          apt:
            name: "{{ item }}"
            state: present
          loop:
            - curl
            - apt-transport-https
            - ca-certificates
            - software-properties-common
            - docker-ce
            - python3-docker
            - nginx
          tags:
            - install

        - name: set +x script
          file: 
            path: /tmp/django/script.sh
            mode: 0755
          tags: 
            - change_permissions            

        - name: Run script = create Dockerfile # это единственный шелл, он нужен для создания web странички
          shell: /bin/bash /tmp/django/script.sh
          tags: 
            - run_script   

        - name: Create a network 
          community.docker.docker_network:
            name: mynet109
            ipam_config:
              - subnet: 172.109.0.0/16         
          tags:
            - create_net
            
        - name: Create 1st container
          community.docker.docker_container:
            name: 1st
            image: "myproject2"
            networks:
              - name: "mynet109"
                ipv4_address: "172.109.0.2"
          tags:
           - create_1st    
  vars:
    docker_network: mynet109
  collections:
    - community.docker
  tasks:
    - name: "get network info"
      docker_network_info:
        name: "{{ docker_network }}"
      register: net_info

    - name: "get container info"
      docker_container_info:
        name: "{{ item  }}"
      register: container_info
      loop: "{{ net_info.network.Containers.keys() }}"

    - debug:
        msg: "{{ item }}"
      loop: "{{ container_info.results|json_query('[].container.Name') }}" 
      
      become: yes
